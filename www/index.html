<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0e27">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Fractal Calm - Visual meditation with infinite mathematical art. Relax, breathe, and find peace.">
    <link rel="manifest" href="manifest.json">
    <title>Fractal Calm - Visual Meditation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #0a0e27;
        }
        
        body {
            font-family: 'Avenir Next', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #fff;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .app {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* Canvas - Full screen background */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        
        /* Overlay gradient for readability */
        .overlay-gradient {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                to bottom,
                rgba(10, 14, 39, 0.4) 0%,
                rgba(10, 14, 39, 0) 30%,
                rgba(10, 14, 39, 0) 70%,
                rgba(10, 14, 39, 0.6) 100%
            );
            pointer-events: none;
            z-index: 1;
        }
        
        /* Main UI Container */
        .ui-container {
            position: relative;
            z-index: 10;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            opacity: 1;
            transition: opacity 0.5s;
        }
        
        .header.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .logo {
            font-size: 1.1em;
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
            opacity: 0.9;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        
        .icon-btn:active {
            transform: scale(0.9);
            background: rgba(255,255,255,0.2);
        }
        
        .icon-btn.active {
            background: rgba(100, 200, 255, 0.3);
            border-color: rgba(100, 200, 255, 0.5);
        }
        
        /* Center content - Breathing guide */
        .center-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        
        .breathing-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            animation: breathe 8s ease-in-out infinite;
            backdrop-filter: blur(5px);
            background: rgba(255,255,255,0.05);
        }
        
        .breathing-circle.paused {
            animation-play-state: paused;
        }
        
        @keyframes breathe {
            0%, 100% { 
                transform: scale(1); 
                border-color: rgba(100, 200, 255, 0.3);
                box-shadow: 0 0 30px rgba(100, 200, 255, 0.1);
            }
            50% { 
                transform: scale(1.3); 
                border-color: rgba(100, 200, 255, 0.6);
                box-shadow: 0 0 60px rgba(100, 200, 255, 0.3);
            }
        }
        
        .breathing-text {
            font-size: 1.2em;
            font-weight: 300;
            letter-spacing: 3px;
            text-transform: uppercase;
            opacity: 0.9;
        }
        
        .session-time {
            font-size: 3em;
            font-weight: 200;
            margin-bottom: 10px;
            font-variant-numeric: tabular-nums;
        }
        
        .session-label {
            font-size: 0.9em;
            opacity: 0.6;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        /* Bottom controls */
        .bottom-controls {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .session-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .session-btn {
            padding: 12px 24px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        
        .session-btn:active {
            transform: scale(0.95);
        }
        
        .session-btn.active {
            background: rgba(100, 200, 255, 0.3);
            border-color: rgba(100, 200, 255, 0.5);
        }
        
        .session-btn.primary {
            background: linear-gradient(135deg, rgba(100, 200, 255, 0.4), rgba(150, 100, 255, 0.4));
            border: none;
            padding: 15px 40px;
            font-size: 16px;
        }
        
        .session-btn.premium {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            border: none;
            color: #000;
            font-weight: 600;
        }
        
        /* Mood selector */
        .mood-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .mood-btn {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .mood-btn:active {
            transform: scale(0.9);
        }
        
        .mood-btn.active {
            border-color: white;
            transform: scale(1.1);
        }
        
        .mood-btn.calm { background: linear-gradient(135deg, #667eea, #764ba2); }
        .mood-btn.focus { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .mood-btn.sleep { background: linear-gradient(135deg, #0f0c29, #302b63); }
        .mood-btn.energy { background: linear-gradient(135deg, #f12711, #f5af19); }
        
        /* Stats bar */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 15px;
            opacity: 0.7;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: 300;
        }
        
        .stat-label {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
        }
        
        /* Premium Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            padding: 20px;
        }
        
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 20px;
            padding: 30px;
            max-width: 350px;
            width: 100%;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        
        .modal-overlay.visible .modal {
            transform: scale(1);
        }
        
        .modal-icon {
            font-size: 50px;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5em;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .modal-text {
            opacity: 0.8;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .modal-features {
            text-align: left;
            margin-bottom: 25px;
        }
        
        .modal-feature {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .modal-feature::before {
            content: '‚úì';
            color: #4ade80;
            font-weight: bold;
        }
        
        .modal-price {
            font-size: 2em;
            font-weight: 300;
            margin-bottom: 5px;
        }
        
        .modal-price-note {
            font-size: 0.8em;
            opacity: 0.6;
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .modal-btn {
            padding: 15px;
            border-radius: 30px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-btn.primary {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #000;
        }
        
        .modal-btn.secondary {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }
        
        /* Session complete */
        .session-complete {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 39, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            text-align: center;
            padding: 30px;
        }
        
        .session-complete.visible {
            opacity: 1;
            pointer-events: all;
        }
        
        .complete-icon {
            font-size: 80px;
            margin-bottom: 30px;
        }
        
        .complete-title {
            font-size: 2em;
            font-weight: 300;
            margin-bottom: 10px;
        }
        
        .complete-subtitle {
            opacity: 0.7;
            margin-bottom: 30px;
        }
        
        .complete-stats {
            display: flex;
            gap: 40px;
            margin-bottom: 40px;
        }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0e27;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.5s;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-logo {
            font-size: 2em;
            font-weight: 200;
            letter-spacing: 5px;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(255,255,255,0.1);
            border-top-color: rgba(100, 200, 255, 0.8);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Intro screen */
        .intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0a0e27, #1a1a3e);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            text-align: center;
            padding: 30px;
            transition: opacity 0.5s;
        }
        
        .intro-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .intro-logo {
            font-size: 2.5em;
            font-weight: 200;
            letter-spacing: 5px;
            margin-bottom: 15px;
        }
        
        .intro-tagline {
            font-size: 1.1em;
            opacity: 0.7;
            margin-bottom: 50px;
            font-weight: 300;
        }
        
        .intro-visual {
            width: 200px;
            height: 200px;
            margin-bottom: 50px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(100,200,255,0.3) 0%, transparent 70%);
            animation: pulse-glow 3s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        
        .intro-start-btn {
            padding: 18px 60px;
            border-radius: 40px;
            border: none;
            background: linear-gradient(135deg, rgba(100, 200, 255, 0.5), rgba(150, 100, 255, 0.5));
            color: white;
            font-size: 18px;
            font-weight: 500;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }
        
        .intro-start-btn:active {
            transform: scale(0.95);
        }
        
        /* Quotes */
        .quote {
            position: absolute;
            bottom: 100px;
            left: 20px;
            right: 20px;
            text-align: center;
            opacity: 0.6;
            font-style: italic;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Hide UI during session */
        .in-session .header,
        .in-session .bottom-controls {
            opacity: 0;
            pointer-events: none;
        }
        
        .in-session .center-content {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="app">
        <canvas id="canvas"></canvas>
        <div class="overlay-gradient"></div>
        
        <div class="ui-container" id="uiContainer">
            <!-- Header -->
            <div class="header" id="header">
                <div class="logo">Fractal Calm</div>
                <div class="header-actions">
                    <button class="icon-btn" id="soundBtn" title="Sound">üîá</button>
                    <button class="icon-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
                </div>
            </div>
            
            <!-- Center -->
            <div class="center-content" id="centerContent">
                <div class="breathing-circle paused" id="breathingCircle">
                    <span class="breathing-text" id="breathingText">Ready</span>
                </div>
                <div class="session-time" id="sessionTime">00:00</div>
                <div class="session-label" id="sessionLabel">Tap to begin</div>
            </div>
            
            <!-- Bottom -->
            <div class="bottom-controls" id="bottomControls">
                <!-- Mood selector -->
                <div class="mood-selector">
                    <button class="mood-btn calm active" data-mood="calm" title="Calm">üåä</button>
                    <button class="mood-btn focus" data-mood="focus" title="Focus">üéØ</button>
                    <button class="mood-btn sleep" data-mood="sleep" title="Sleep">üåô</button>
                    <button class="mood-btn energy" data-mood="energy" title="Energy">‚ö°</button>
                </div>
                
                <!-- Session duration -->
                <div class="session-buttons">
                    <button class="session-btn" data-duration="180">3 min</button>
                    <button class="session-btn active" data-duration="300">5 min</button>
                    <button class="session-btn" data-duration="600">10 min</button>
                    <button class="session-btn premium" data-duration="900" id="premiumSession">15 min ‚≠ê</button>
                </div>
                
                <!-- Start button -->
                <button class="session-btn primary" id="startBtn">Begin Session</button>
                
                <!-- Stats -->
                <div class="stats-bar">
                    <div class="stat-item">
                        <div class="stat-value" id="totalSessions">0</div>
                        <div class="stat-label">Sessions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalMinutes">0</div>
                        <div class="stat-label">Minutes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="currentStreak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Intro Screen -->
        <div class="intro-screen" id="introScreen">
            <div class="intro-logo">FRACTAL CALM</div>
            <div class="intro-tagline">Visual meditation for inner peace</div>
            <div class="intro-visual"></div>
            <button class="intro-start-btn" id="introStartBtn">Enter</button>
            <div class="quote">"In the infinity of patterns, find your stillness."</div>
        </div>
        
        <!-- Premium Modal -->
        <div class="modal-overlay" id="premiumModal">
            <div class="modal">
                <div class="modal-icon">‚ú®</div>
                <div class="modal-title">Unlock Full Experience</div>
                <div class="modal-text">You've completed 3 free sessions. Unlock unlimited access to find deeper calm.</div>
                <div class="modal-features">
                    <div class="modal-feature">Unlimited session lengths</div>
                    <div class="modal-feature">All 12 visual themes</div>
                    <div class="modal-feature">Premium soundscapes</div>
                    <div class="modal-feature">Detailed progress tracking</div>
                    <div class="modal-feature">No ads, ever</div>
                </div>
                <div class="modal-price">‚Ç¨4.99</div>
                <div class="modal-price-note">One-time purchase ‚Ä¢ Lifetime access</div>
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="buyPremiumBtn">Unlock Premium</button>
                    <button class="modal-btn secondary" id="closePremiumBtn">Maybe Later</button>
                </div>
            </div>
        </div>
        
        <!-- Session Complete -->
        <div class="session-complete" id="sessionComplete">
            <div class="complete-icon">üßò</div>
            <div class="complete-title">Session Complete</div>
            <div class="complete-subtitle">You spent <span id="completeDuration">5</span> minutes in calm</div>
            <div class="complete-stats">
                <div class="stat-item">
                    <div class="stat-value" id="completeBreaths">42</div>
                    <div class="stat-label">Breaths</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="completeDepth">Deep</div>
                    <div class="stat-label">Zoom Depth</div>
                </div>
            </div>
            <button class="session-btn primary" id="continueBtn">Continue</button>
        </div>
        
        <!-- Loading -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-logo">FRACTAL CALM</div>
            <div class="loading-spinner"></div>
        </div>
    </div>

    <script>
        // ============ APP STATE ============
        const state = {
            // Fractal view
            centerX: -0.5,
            centerY: 0,
            scale: 2.5,
            cReal: -0.7,
            cImag: 0.27015,
            maxIterations: 80,
            
            // Mood themes
            currentMood: 'calm',
            moods: {
                calm: { colors: ['#667eea', '#764ba2', '#f5f7fa'], cReal: -0.7, cImag: 0.27015, speed: 0.3 },
                focus: { colors: ['#11998e', '#38ef7d', '#0f3443'], cReal: -0.4, cImag: 0.6, speed: 0.5 },
                sleep: { colors: ['#0f0c29', '#302b63', '#24243e'], cReal: -0.8, cImag: 0.156, speed: 0.15 },
                energy: { colors: ['#f12711', '#f5af19', '#ffecd2'], cReal: 0.285, cImag: 0.01, speed: 0.7 }
            },
            
            // Session
            isInSession: false,
            sessionDuration: 300, // 5 min default
            sessionTimeLeft: 0,
            sessionStartTime: 0,
            breathCount: 0,
            
            // Premium
            isPremium: false,
            freeSessionsUsed: 0,
            maxFreeSessions: 3,
            
            // Stats
            totalSessions: 0,
            totalMinutes: 0,
            currentStreak: 0,
            lastSessionDate: null,
            
            // Audio
            audioEnabled: false,
            
            // Rendering
            quality: 2.5
        };
        
        // ============ DOM ============
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // ============ STORAGE ============
        function loadState() {
            try {
                const saved = localStorage.getItem('fractalcalm_state');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.isPremium = data.isPremium || false;
                    state.freeSessionsUsed = data.freeSessionsUsed || 0;
                    state.totalSessions = data.totalSessions || 0;
                    state.totalMinutes = data.totalMinutes || 0;
                    state.currentStreak = data.currentStreak || 0;
                    state.lastSessionDate = data.lastSessionDate || null;
                    updateStats();
                }
            } catch (e) {}
        }
        
        function saveState() {
            try {
                localStorage.setItem('fractalcalm_state', JSON.stringify({
                    isPremium: state.isPremium,
                    freeSessionsUsed: state.freeSessionsUsed,
                    totalSessions: state.totalSessions,
                    totalMinutes: state.totalMinutes,
                    currentStreak: state.currentStreak,
                    lastSessionDate: state.lastSessionDate
                }));
            } catch (e) {}
        }
        
        // ============ AUDIO ============
        let audioContext = null;
        let oscillators = [];
        let masterGain = null;
        
        function initAudio() {
            if (audioContext) return;
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            masterGain = audioContext.createGain();
            masterGain.gain.value = 0.03;
            masterGain.connect(audioContext.destination);
            
            const mood = state.moods[state.currentMood];
            const baseFreq = state.currentMood === 'sleep' ? 60 : 120;
            
            [1, 1.5, 2, 2.5].forEach(mult => {
                const osc = audioContext.createOscillator();
                osc.type = 'sine';
                osc.frequency.value = baseFreq * mult;
                
                const gain = audioContext.createGain();
                gain.gain.value = 0.02 / mult;
                
                osc.connect(gain);
                gain.connect(masterGain);
                osc.start();
                oscillators.push(osc);
            });
        }
        
        function stopAudio() {
            oscillators.forEach(o => o.stop());
            oscillators = [];
            if (audioContext) audioContext.close();
            audioContext = null;
        }
        
        // ============ COMPLEX MATH ============
        const cmul = (a, b) => ({ real: a.real * b.real - a.imag * b.imag, imag: a.real * b.imag + a.imag * b.real });
        const cadd = (a, b) => ({ real: a.real + b.real, imag: a.imag + b.imag });
        const cabs = a => Math.sqrt(a.real * a.real + a.imag * a.imag);
        
        function iterate(x, y) {
            let z = { real: x, imag: y };
            const c = { real: state.cReal, imag: state.cImag };
            for (let i = 0; i < state.maxIterations; i++) {
                if (cabs(z) > 2) return i;
                z = cadd(cmul(z, z), c);
            }
            return state.maxIterations;
        }
        
        // ============ COLORS ============
        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return { r, g, b };
        }
        
        function getColor(iter) {
            if (iter >= state.maxIterations) return [10, 14, 39];
            
            const mood = state.moods[state.currentMood];
            const colors = mood.colors.map(hexToRgb);
            const ratio = iter / state.maxIterations;
            
            let c1, c2, t;
            if (ratio < 0.5) {
                c1 = colors[0];
                c2 = colors[1];
                t = ratio * 2;
            } else {
                c1 = colors[1];
                c2 = colors[2];
                t = (ratio - 0.5) * 2;
            }
            
            return [
                Math.round(c1.r + (c2.r - c1.r) * t),
                Math.round(c1.g + (c2.g - c1.g) * t),
                Math.round(c1.b + (c2.b - c1.b) * t)
            ];
        }
        
        // ============ RENDERING ============
        function render() {
            const w = Math.floor(canvas.width / state.quality);
            const h = Math.floor(canvas.height / state.quality);
            
            const offCanvas = document.createElement('canvas');
            offCanvas.width = w;
            offCanvas.height = h;
            const offCtx = offCanvas.getContext('2d');
            const imageData = offCtx.createImageData(w, h);
            const data = imageData.data;
            
            const aspect = canvas.width / canvas.height;
            const scaleX = state.scale * (aspect > 1 ? aspect : 1);
            const scaleY = state.scale * (aspect < 1 ? 1 / aspect : 1);
            
            for (let py = 0; py < h; py++) {
                for (let px = 0; px < w; px++) {
                    const x = state.centerX + (px / w - 0.5) * scaleX;
                    const y = state.centerY + (py / h - 0.5) * scaleY;
                    const iter = iterate(x, y);
                    const [r, g, b] = getColor(iter);
                    const idx = (py * w + px) * 4;
                    data[idx] = r;
                    data[idx + 1] = g;
                    data[idx + 2] = b;
                    data[idx + 3] = 255;
                }
            }
            
            offCtx.putImageData(imageData, 0, 0);
            ctx.imageSmoothingEnabled = true;
            ctx.drawImage(offCanvas, 0, 0, w, h, 0, 0, canvas.width, canvas.height);
        }
        
        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            render();
        }
        
        // ============ ANIMATION ============
        let animationFrame = null;
        let animationTime = 0;
        
        function animate() {
            if (!state.isInSession) return;
            
            const mood = state.moods[state.currentMood];
            animationTime += 0.016 * mood.speed;
            
            // Slowly evolve fractal
            state.cReal = mood.cReal + Math.sin(animationTime * 0.2) * 0.05;
            state.cImag = mood.cImag + Math.cos(animationTime * 0.15) * 0.03;
            
            // Slowly zoom in
            if (state.scale > 0.01) {
                state.scale *= 0.9995;
            } else {
                // Reset zoom with smooth transition
                state.scale = 2.5;
                state.centerX = -0.5 + (Math.random() - 0.5) * 0.3;
                state.centerY = (Math.random() - 0.5) * 0.3;
            }
            
            render();
            animationFrame = requestAnimationFrame(animate);
        }
        
        // ============ BREATHING ============
        let breathPhase = 0;
        const breathTexts = ['Breathe In', 'Hold', 'Breathe Out', 'Hold'];
        const breathDurations = [4, 2, 4, 2]; // 4-2-4-2 pattern
        
        function updateBreathing() {
            if (!state.isInSession) return;
            
            const circle = document.getElementById('breathingCircle');
            const text = document.getElementById('breathingText');
            
            text.textContent = breathTexts[breathPhase];
            state.breathCount++;
            
            breathPhase = (breathPhase + 1) % 4;
            
            setTimeout(updateBreathing, breathDurations[breathPhase] * 1000);
        }
        
        // ============ SESSION ============
        let sessionInterval = null;
        
        function startSession() {
            // Check premium
            if (!state.isPremium && state.freeSessionsUsed >= state.maxFreeSessions) {
                showPremiumModal();
                return;
            }
            
            if (state.sessionDuration > 600 && !state.isPremium) {
                showPremiumModal();
                return;
            }
            
            state.isInSession = true;
            state.sessionTimeLeft = state.sessionDuration;
            state.sessionStartTime = Date.now();
            state.breathCount = 0;
            animationTime = 0;
            breathPhase = 0;
            
            // Apply mood
            const mood = state.moods[state.currentMood];
            state.cReal = mood.cReal;
            state.cImag = mood.cImag;
            state.scale = 2.5;
            
            document.getElementById('uiContainer').classList.add('in-session');
            document.getElementById('breathingCircle').classList.remove('paused');
            document.getElementById('sessionLabel').textContent = 'Session in progress';
            document.getElementById('startBtn').textContent = 'End Session';
            
            if (state.audioEnabled) initAudio();
            
            // Start animations
            animate();
            updateBreathing();
            
            // Timer
            sessionInterval = setInterval(() => {
                state.sessionTimeLeft--;
                updateSessionTime();
                
                if (state.sessionTimeLeft <= 0) {
                    endSession(true);
                }
            }, 1000);
            
            haptic('medium');
        }
        
        function endSession(completed = false) {
            state.isInSession = false;
            
            if (animationFrame) cancelAnimationFrame(animationFrame);
            if (sessionInterval) clearInterval(sessionInterval);
            
            document.getElementById('uiContainer').classList.remove('in-session');
            document.getElementById('breathingCircle').classList.add('paused');
            document.getElementById('breathingText').textContent = 'Ready';
            document.getElementById('sessionLabel').textContent = 'Tap to begin';
            document.getElementById('startBtn').textContent = 'Begin Session';
            document.getElementById('sessionTime').textContent = '00:00';
            
            stopAudio();
            
            if (completed) {
                // Update stats
                state.totalSessions++;
                state.totalMinutes += Math.round(state.sessionDuration / 60);
                state.freeSessionsUsed++;
                
                // Streak logic
                const today = new Date().toDateString();
                if (state.lastSessionDate !== today) {
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    if (state.lastSessionDate === yesterday) {
                        state.currentStreak++;
                    } else {
                        state.currentStreak = 1;
                    }
                    state.lastSessionDate = today;
                }
                
                saveState();
                updateStats();
                showSessionComplete();
                haptic('heavy');
            }
        }
        
        function updateSessionTime() {
            const mins = Math.floor(state.sessionTimeLeft / 60);
            const secs = state.sessionTimeLeft % 60;
            document.getElementById('sessionTime').textContent = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function updateStats() {
            document.getElementById('totalSessions').textContent = state.totalSessions;
            document.getElementById('totalMinutes').textContent = state.totalMinutes;
            document.getElementById('currentStreak').textContent = state.currentStreak;
        }
        
        function showSessionComplete() {
            document.getElementById('completeDuration').textContent = Math.round(state.sessionDuration / 60);
            document.getElementById('completeBreaths').textContent = Math.round(state.breathCount / 4);
            document.getElementById('completeDepth').textContent = state.scale < 0.1 ? 'Very Deep' : 'Deep';
            document.getElementById('sessionComplete').classList.add('visible');
        }
        
        // ============ PREMIUM ============
        function showPremiumModal() {
            document.getElementById('premiumModal').classList.add('visible');
            haptic('light');
        }
        
        function hidePremiumModal() {
            document.getElementById('premiumModal').classList.remove('visible');
        }
        
        function purchasePremium() {
            // In real app, this would trigger in-app purchase
            // For demo, just unlock
            state.isPremium = true;
            saveState();
            hidePremiumModal();
            alert('Premium unlocked! Thank you for your support.');
        }
        
        // ============ HAPTIC ============
        function haptic(type = 'light') {
            if ('vibrate' in navigator) {
                const durations = { light: 10, medium: 25, heavy: 50 };
                navigator.vibrate(durations[type] || 10);
            }
        }
        
        // ============ EVENT LISTENERS ============
        function initEvents() {
            // Intro
            document.getElementById('introStartBtn').onclick = () => {
                document.getElementById('introScreen').classList.add('hidden');
                haptic('medium');
            };
            
            // Sound toggle
            document.getElementById('soundBtn').onclick = () => {
                state.audioEnabled = !state.audioEnabled;
                document.getElementById('soundBtn').textContent = state.audioEnabled ? 'üîä' : 'üîá';
                document.getElementById('soundBtn').classList.toggle('active', state.audioEnabled);
                if (state.isInSession) {
                    if (state.audioEnabled) initAudio();
                    else stopAudio();
                }
                haptic('light');
            };
            
            // Mood buttons
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.currentMood = btn.dataset.mood;
                    
                    const mood = state.moods[state.currentMood];
                    state.cReal = mood.cReal;
                    state.cImag = mood.cImag;
                    render();
                    haptic('light');
                };
            });
            
            // Duration buttons
            document.querySelectorAll('.session-btn[data-duration]').forEach(btn => {
                btn.onclick = () => {
                    const duration = parseInt(btn.dataset.duration);
                    
                    if (duration > 600 && !state.isPremium) {
                        showPremiumModal();
                        return;
                    }
                    
                    document.querySelectorAll('.session-btn[data-duration]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.sessionDuration = duration;
                    haptic('light');
                };
            });
            
            // Start button
            document.getElementById('startBtn').onclick = () => {
                if (state.isInSession) {
                    endSession(false);
                } else {
                    startSession();
                }
            };
            
            // Tap center to toggle UI during session
            document.getElementById('centerContent').onclick = () => {
                if (state.isInSession) {
                    const ui = document.getElementById('uiContainer');
                    ui.classList.toggle('in-session');
                }
            };
            
            // Premium modal
            document.getElementById('buyPremiumBtn').onclick = purchasePremium;
            document.getElementById('closePremiumBtn').onclick = hidePremiumModal;
            
            // Session complete
            document.getElementById('continueBtn').onclick = () => {
                document.getElementById('sessionComplete').classList.remove('visible');
            };
            
            // Resize
            window.addEventListener('resize', resizeCanvas);
        }
        
        // ============ INIT ============
        function init() {
            loadState();
            resizeCanvas();
            initEvents();
            render();
            
            // Hide loading
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }, 800);
            
            // Register SW
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(() => {});
            }
        }
        
        init();
    </script>
</body>
</html>